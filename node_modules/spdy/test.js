var spdy = require('./');
var fs = require('fs');
var zlib = require('zlib');

var options = {
  key: "-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAy7cOroyn0xXc4sZfHoPHyUT5/g6ygqOyhKWe7uLCKuGxmZCb\nN9jVP/KJuMtSvHkkL9EiYG8PLf2/KYvKi30MVV4+Mm44UdoP5dp7Fdoa+Y4BpbZd\nV21MCcexN4hqMwRpQ0YwAdmZi+dfKPgOY2J1o0w4rwJZiDI2wXuDaaYzQOVpsnMw\nVv5gmIwpaZn7rtFxhgzd78hCnx/NtwYdK54jeSiDBWl78ZT80xrn8HcaKK0DnyDX\neJprOQ7WhZbBKQylSikE5ZscsXyWwPouK2rxoObGeJJOUnxI8IkrzQKukkCCkQi1\nuh9y9xp0lpSrVm97bQ7li+S9n58u3IY4ZrU7PQIDAQABAoIBAGk2imasTqE+0W5u\ndgIUncLd1R/aB2hhk3ne8E8A3re3CTr+7KvTWZBFe8vtdzXQe1gW82JK+dQPEgQr\nJtkUJKKSohz5wCzGKx/Tz25hzzzEkyU7IspcsMD8WhMMaY0f4h3UykaqVBtlzEgk\nlYnO+GL2ovAAjq1BAfa8DAssw5vn9FWooNtfA+uXisixGfoe3iUsci54SbfRua0Y\nkxhpjwTXBrX0fIM8EKDp/PP1oFSqHjNkHYiMEJDbY7gN5Q1naAM+c2kggIAJ1r+G\nOpMP/qTPWRBaYjUmvZF+M4SdACYDQ9WvW2FOVgNwMlO9mW2+QPmS7EOWk79qKjaK\ns3OlGCECgYEA1Uk9y56WQE+eDcg/HDazJD2DnpbtPwlc+QchCqPcL2MczKWrxFRM\nx4Vdbr4Yt9xVvJSrL3qz/Im4EO10mrSRLMlR8pYTZTyciwXq6JExvo8BO8EPa7KC\nlN4EwU89hM+BgVxUAksOolcsXt8Mzv9tyXPQ6sZlJv+Ei3FBF/gPJ2sCgYEA9IMg\nxa5NoUN1WcSZt9/CJkl8D+N0owRW8AtsTScnun8ounNhm9gmWzQBYIaiPTDaT7ZH\nTUIjeWrv/5fhEV/Bb1jMAlcf0N1pV7c1zFbM8RUO4iZkbnUR0xwrbz/9ZcJ6cAuZ\nKag7DZnkmjHfvIyOgHst10QOFaRqbuUH8LSmWfcCgYB0a8c0ZztCnXL7uOth/iWo\nyX8XyPB1cSnzsMWDZlAg+avVtTTeNNm4Kv8GHPOnILkX99q9TvACEDaN3t/ANoHr\n/XQiw3KQ1xXn+PHxwpdxmeOld0twkP8gPVRBJHzDCvV45CnjGo9BY+4PVxdJwjlu\nNi66iFLch6sU5lwOtlOnQwKBgA4zJ04Tp1J8Nm52Km8xQXczwU6y6O0mrV3Xa/y3\nD2mXROg/FyYT0XZueL4AU5+2HJeQgGeONb0xZqqzSVDW/MbYo1BneuOIWDvN2gP5\n7oD5thmQHTkE93oJIsSdNLwaJT4ojkaLDJLnow0JZHLwvr3baXgc7ax4Fe5GwsVJ\n2HdVAoGBAJ6e681+Yfsd46JvOkAJxUQrp2iK8iU7tzJwqSDdVmESFkfssaU//fVB\nLuklGQhm1GX2pmbwAgojLMXH+FwSwOfwA1/rdljMQ+0OxdgQO35pzkKOb3S0rgT6\nDKeNkFF5kyXgzGtIgHGA2e9LkK/gXMfDyej4Occ+3+JBpJQtpclk\n-----END RSA PRIVATE KEY-----",
  cert: "-----BEGIN CERTIFICATE-----\nMIICvDCCAaagAwIBAgIDAQABMAsGCSqGSIb3DQEBDTAVMRMwEQYDVQQDFgpsb2Nh\nbC5ob3N0MB4XDTE1MTEzMDE5NTM0MloXDTI1MTEyODE5NTM0MlowFTETMBEGA1UE\nAxYKbG9jYWwuaG9zdDCCASAwCwYJKoZIhvcNAQEBA4IBDwAwggEKAoIBAQDLtw6u\njKfTFdzixl8eg8fJRPn+DrKCo7KEpZ7u4sIq4bGZkJs32NU/8om4y1K8eSQv0SJg\nbw8t/b8pi8qLfQxVXj4ybjhR2g/l2nsV2hr5jgGltl1XbUwJx7E3iGozBGlDRjAB\n2ZmL518o+A5jYnWjTDivAlmIMjbBe4NppjNA5WmyczBW/mCYjClpmfuu0XGGDN3v\nyEKfH823Bh0rniN5KIMFaXvxlPzTGufwdxoorQOfINd4mms5DtaFlsEpDKVKKQTl\nmxyxfJbA+i4ravGg5sZ4kk5SfEjwiSvNAq6SQIKRCLW6H3L3GnSWlKtWb3ttDuWL\n5L2fny7chjhmtTs9AgMBAAGjGzAZMBcGA1UdEQQQMA6CDCoubG9jYWwuaG9zdDAL\nBgkqhkiG9w0BAQ0DggEBAMDbFsKra9nZK3FetaxMPheh9T8U+wwVzeN96H0pk+9P\nb+LvIa+Wdrm0eIr1wAQ7brpZXgXH5ol+HoiNdUhTBrWPQxluKZNou8J5CVrrOc/l\nn9hV9Zx3NqCmho8xYYsVbuB+1yzzqSLGCL+7jPzPIlPT96mxzxk/9V2ArypQGiGf\n34aDQL94aha0jqszjLs4nzHLILapbZM9kH4P06VMKalXs+rEuLoV6uksF4Om2NLB\nV7r7lkpjDnT4leTgZwfQN1Ukdt4Z8hZPjZ6dj1ckPo6mZ9+NxNvfLLG7v2J8tga+\n/oyJZjqFv6a68SIovnFsTrTXsL2G6Utr68n4FhLqqfE=\n-----END CERTIFICATE-----"
};

var MIME = {
  'js': 'application/javascript',
  'css': 'text/css',
  'png': 'image/png'
};

spdy.createServer(options, function(req, res) {
    ['/app/main.js'].forEach(function(url){
        console.log('fetching',url);
      var stream = res.push(url, {
        response: {
          'content-type': `${MIME[url.substr(url.lastIndexOf('.')+1)]};charset=utf-8`,
          'content-encoding' : 'deflate',
        }
      });
      stream.on('error', function(er) {
          throw er;
      });

      var fstream = fs.createReadStream('/tmp'+url);
      var zstream = zlib.createDeflate();
      fstream.pipe(zstream).pipe(stream);
    });


    setTimeout(function() {
      res.end(`
        <!DOCTYPE html>
        <html>
            <head>
                <script src="/app/main.js" async></script>
                <link rel="stylesheet" href="/app/main.css" async>
                <link rel="icon" type="image/png" href="/app/favicon-32x32.png" sizes="32x32" async>
                <meta name="viewport" content="width=device-width, initial-scale=1">
            </head>
            <body></body>
        </html>`
      );
    }, 500);
}).listen(1443, function() {
  console.log('Listening on %j', this.address());
});
